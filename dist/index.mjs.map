{"version":3,"sources":["../src/useEaoAnalytics.ts","../src/utils/tokenExtractor.ts","../src/utils/apiClient.ts"],"sourcesContent":["import { useEffect, useRef, useState } from 'react';\nimport { useAuth } from 'react-oidc-context';\nimport { extractUserInfo } from './utils/tokenExtractor';\nimport { trackLogin } from './utils/apiClient';\nimport { EaoAnalyticsOptions } from './types';\n\nconst ANALYTICS_DEBOUNCE_MS = 5000; // 5 seconds\nconst SESSION_STORAGE_KEY = 'epic_eao_analytics_last_recorded';\n\ninterface AnalyticsState {\n  lastRecorded: number;\n  appName: string;\n}\n\n/**\n * React hook to record user login analytics across EPIC applications\n * Automatically records login analytics when user is authenticated\n */\nexport function trackAnalytics(options: EaoAnalyticsOptions) {\n  const { appName, centreApiUrl, enabled = true, onSuccess, onError } = options;\n  const { user, isAuthenticated } = useAuth();\n  const [isRecording, setIsRecording] = useState(false);\n  const [error, setError] = useState<Error | null>(null);\n  const recordingRef = useRef(false);\n\n  useEffect(() => {\n    if (!enabled || !isAuthenticated || !user) {\n      return;\n    }\n\n    if (recordingRef.current) {\n      return;\n    }\n\n      const stored = sessionStorage.getItem(SESSION_STORAGE_KEY);\n      if (stored) {\n        const state: AnalyticsState = JSON.parse(stored);\n        const timeSinceLastRecord = Date.now() - state.lastRecorded;\n        \n        // If same app and recorded recently, skip\n        if (state.appName === appName && timeSinceLastRecord < ANALYTICS_DEBOUNCE_MS) {\n          return;\n        }\n      }\n\n    // Check if identity_provider is \"idir\" - only send analytics for IDIR users\n    const identityProvider = user.profile?.identity_provider;\n    if (identityProvider !== 'idir') {\n      return;\n    }\n\n    // Extract user info from token\n    const userInfo = extractUserInfo(user);\n    if (!userInfo) {\n      console.warn('EAO Analytics: Could not extract user info from token');\n      return;\n    }\n\n    // Get access token\n    const accessToken = user.access_token;\n    if (!accessToken) {\n      console.warn('EAO Analytics: No access token available');\n      return;\n    }\n\n    // Record analytics\n    const performAnalytics = async () => {\n      recordingRef.current = true;\n      setIsRecording(true);\n      setError(null);\n\n      try {\n        await trackLogin(centreApiUrl, accessToken, {\n          user_auth_guid: userInfo.user_auth_guid,\n          app_name: appName,\n        });\n\n        // Store analytics state in sessionStorage\n          sessionStorage.setItem(\n            SESSION_STORAGE_KEY,\n            JSON.stringify({\n              lastRecorded: Date.now(),\n              appName,\n            } as AnalyticsState)\n          );\n\n\n        onSuccess?.();\n      } catch (err) {\n        const error = err instanceof Error ? err : new Error('Unknown error');\n        setError(error);\n        onError?.(error);\n      } finally {\n        setIsRecording(false);\n        recordingRef.current = false;\n      }\n    };\n\n    performAnalytics();\n  }, [isAuthenticated, user, appName, centreApiUrl, enabled, onSuccess, onError]);\n\n  return {\n    isRecording,\n    error,\n  };\n}\n\n","import { User } from 'react-oidc-context';\r\nimport { UserInfo } from '../types';\r\n\r\n/**\r\n * Extract user_auth_guid from OIDC user object\r\n * Uses preferred_username as user_auth_guid\r\n */\r\nexport function extractUserInfo(user: User | null | undefined): UserInfo | null {\r\n  if (!user || !user.profile) {\r\n    return null;\r\n  }\r\n\r\n  const profile = user.profile;\r\n\r\n  const user_auth_guid = profile.preferred_username || profile.sub;\r\n  \r\n  if (!user_auth_guid) {\r\n    return null;\r\n  }\r\n\r\n  return {\r\n    user_auth_guid,\r\n  };\r\n}\r\n\r\n","import axios, { AxiosError } from 'axios';\r\nimport { EaoAnalyticsPayload } from '../types';\r\n\r\n/**\r\n * Record user login analytics by calling EPIC.centre API\r\n * @param apiUrl - Base URL of EPIC.centre API\r\n * @param accessToken - User's access token for authentication\r\n * @param payload - EAO Analytics payload\r\n */\r\nexport async function trackLogin(\r\n  apiUrl: string,\r\n  accessToken: string,\r\n  payload: EaoAnalyticsPayload\r\n): Promise<void> {\r\n  if (!apiUrl) {\r\n    throw new Error('EPIC.centre API URL is required');\r\n  }\r\n\r\n  if (!accessToken) {\r\n    throw new Error('Access token is required');\r\n  }\r\n\r\n  const baseUrl = apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;\r\n  const endpoint = `${baseUrl}/api/eao-analytics`;\r\n\r\n  try {\r\n    await axios.post(\r\n      endpoint,\r\n      payload,\r\n      {\r\n        headers: {\r\n          'Authorization': `Bearer ${accessToken}`,\r\n          'Content-Type': 'application/json',\r\n        },\r\n        timeout: 10000,\r\n      }\r\n    );\r\n  } catch (error) {\r\n    if (axios.isAxiosError(error)) {\r\n      const axiosError = error as AxiosError;\r\n      if (axiosError.response) {\r\n        throw new Error(\r\n          `EAO Analytics recording failed: ${axiosError.response.status} ${axiosError.response.statusText}`\r\n        );\r\n      } else if (axiosError.request) {\r\n        throw new Error('EAO Analytics recording failed: No response from server');\r\n      }\r\n    }\r\n    throw error instanceof Error ? error : new Error('EAO Analytics recording failed: Unknown error');\r\n  }\r\n}\r\n\r\n"],"mappings":"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","names":["error"]}