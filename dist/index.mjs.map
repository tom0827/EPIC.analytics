{"version":3,"sources":["../src/useEaoAnalytics.ts","../src/utils/tokenExtractor.ts","../src/utils/apiClient.ts"],"sourcesContent":["import { useEffect, useRef, useState } from 'react';\nimport { useAuth } from 'react-oidc-context';\nimport { extractUserInfo } from './utils/tokenExtractor';\nimport { trackLogin } from './utils/apiClient';\nimport { EaoAnalyticsOptions } from './types';\n\nconst DEBOUNCE_MS = 5000;\nconst STORAGE_KEY = 'epic_eao_analytics_last_recorded';\n\nfunction useAuthState(authState?: EaoAnalyticsOptions['authState']) {\n  if (authState) {\n    return {\n      user: authState.user,\n      isAuthenticated: authState.isAuthenticated,\n    };\n  }\n  const auth = useAuth();\n  return {\n    user: auth.user,\n    isAuthenticated: auth.isAuthenticated,\n  };\n}\n\nfunction isIdirUser(user: { profile?: Record<string, unknown> } | null | undefined): boolean {\n  return (user?.profile as { identity_provider?: string } | undefined)?.identity_provider === 'idir';\n}\n\nfunction wasRecentlyRecorded(appName: string): boolean {\n  const stored = sessionStorage.getItem(STORAGE_KEY);\n  if (!stored) return false;\n  try {\n    const { lastRecorded, appName: storedApp } = JSON.parse(stored);\n    const elapsed = Date.now() - lastRecorded;\n    return storedApp === appName && elapsed < DEBOUNCE_MS;\n  } catch {\n    return false;\n  }\n}\n\nfunction saveRecordedTimestamp(appName: string): void {\n  if (typeof sessionStorage !== 'undefined') {\n    sessionStorage.setItem(STORAGE_KEY, JSON.stringify({ lastRecorded: Date.now(), appName }));\n  }\n}\n\n/** Options for recordAnalytics when using authState (no React hooks). */\nexport type RecordAnalyticsOptions = EaoAnalyticsOptions & {\n  authState: NonNullable<EaoAnalyticsOptions['authState']>;\n};\n\n/**\n * Record analytics once without using React hooks. Use when the app provides\n * authState (e.g. Redux apps like Engage, Track) to avoid duplicate React issues.\n */\nexport async function recordAnalytics(options: RecordAnalyticsOptions): Promise<void> {\n  const { appName, centreApiUrl, enabled = true, onSuccess, onError, authState } = options;\n  const { user, isAuthenticated } = authState;\n\n  if (!enabled || !isAuthenticated || !user) return;\n  if (wasRecentlyRecorded(appName)) return;\n\n  const userInfo = extractUserInfo(user);\n  if (!userInfo) {\n    console.warn('EAO Analytics: Could not extract user info');\n    return;\n  }\n\n  const rawToken = user.access_token;\n  if (!rawToken) {\n    console.warn('EAO Analytics: No access token available');\n    return;\n  }\n\n  try {\n    await trackLogin(centreApiUrl, rawToken, {\n      user_auth_guid: userInfo.user_auth_guid,\n      app_name: appName,\n    });\n    saveRecordedTimestamp(appName);\n    onSuccess?.();\n  } catch (err) {\n    const e = err instanceof Error ? err : new Error('Unknown error');\n    onError?.(e);\n    throw e;\n  }\n}\n\nexport function trackAnalytics(options: EaoAnalyticsOptions) {\n  const { appName, centreApiUrl, enabled = true, onSuccess, onError, authState } = options;\n  const { user, isAuthenticated } = useAuthState(authState);\n  const [isRecording, setIsRecording] = useState(false);\n  const [error, setError] = useState<Error | null>(null);\n  const hasRecorded = useRef(false);\n\n  useEffect(() => {\n    if (!enabled || !isAuthenticated || !user || hasRecorded.current) return;\n    if (wasRecentlyRecorded(appName)) return;\n    if (!authState && !isIdirUser(user)) return;\n\n    const userInfo = extractUserInfo(user);\n    if (!userInfo) {\n      console.warn('EAO Analytics: Could not extract user info');\n      return;\n    }\n\n    const rawToken = user.access_token;\n    if (!rawToken) {\n      console.warn('EAO Analytics: No access token available');\n      return;\n    }\n\n    const token: string = rawToken;\n    const payloadUserGuid = userInfo.user_auth_guid;\n    const payloadAppName = appName;\n\n    async function recordAnalytics() {\n      hasRecorded.current = true;\n      setIsRecording(true);\n      setError(null);\n      try {\n        await trackLogin(centreApiUrl, token, {\n          user_auth_guid: payloadUserGuid,\n          app_name: payloadAppName,\n        });\n        saveRecordedTimestamp(payloadAppName);\n        onSuccess?.();\n      } catch (err) {\n        const e = err instanceof Error ? err : new Error('Unknown error');\n        setError(e);\n        onError?.(e);\n      } finally {\n        setIsRecording(false);\n        hasRecorded.current = false;\n      }\n    }\n\n    recordAnalytics();\n  }, [isAuthenticated, user, appName, centreApiUrl, enabled, onSuccess, onError, authState]);\n\n  return { isRecording, error };\n}\n","import { UserInfo } from '../types';\r\n\r\ntype UserLike = { profile?: { preferred_username?: string; sub?: string } } | null | undefined;\r\n\r\nexport function extractUserInfo(user: UserLike): UserInfo | null {\r\n  if (!user || !user.profile) {\r\n    return null;\r\n  }\r\n\r\n  const profile = user.profile;\r\n\r\n  const user_auth_guid = profile.preferred_username || profile.sub;\r\n  \r\n  if (!user_auth_guid) {\r\n    return null;\r\n  }\r\n\r\n  return {\r\n    user_auth_guid,\r\n  };\r\n}\r\n\r\n","import { EaoAnalyticsPayload } from '../types';\r\n\r\nexport async function trackLogin(\r\n  apiUrl: string,\r\n  accessToken: string,\r\n  payload: EaoAnalyticsPayload\r\n): Promise<void> {\r\n  if (!apiUrl) throw new Error('EPIC.centre API URL is required');\r\n  if (!accessToken) throw new Error('Access token is required');\r\n\r\n  const baseUrl = apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;\r\n  const response = await fetch(`${baseUrl}/api/eao-analytics`, {\r\n    method: 'POST',\r\n    headers: {\r\n      Authorization: `Bearer ${accessToken}`,\r\n      'Content-Type': 'application/json',\r\n    },\r\n    body: JSON.stringify(payload),\r\n    keepalive: true,\r\n  });\r\n\r\n  if (!response.ok) {\r\n    throw new Error(\r\n      `EAO Analytics recording failed: ${response.status} ${response.statusText}`\r\n    );\r\n  }\r\n}\r\n"],"mappings":"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","names":["recordAnalytics"]}